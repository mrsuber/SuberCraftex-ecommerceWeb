// This is your Prisma schema file
// SuberCraftex E-Commerce Platform
// Migrated from Supabase to custom auth with Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTH & USER MANAGEMENT
// ============================================================================

enum UserRole {
  customer
  admin
  driver
  cashier
  tailor
  investor
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String    @map("password_hash")
  role              UserRole  @default(customer)
  fullName          String?   @map("full_name")
  phone             String?
  avatarUrl         String?   @map("avatar_url")
  emailVerified     Boolean   @default(false) @map("email_verified")
  emailVerifiedAt   DateTime? @map("email_verified_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  orders              Order[]
  cartItems           CartItem[]
  wishlists           Wishlist[]
  reviews             Review[]
  addresses           Address[]
  driver              Driver?
  cashier             Cashier?
  tailor              Tailor?
  investor            Investor?
  inventoryLogs       InventoryLog[]
  emailVerifications  EmailVerification[]
  purchaseOrders      PurchaseOrder[]
  goodsReceipts       GoodsReceipt[]
  serviceBookings     ServiceBooking[]
  cartItemServices    CartItemService[]
  bookingReviews      BookingReview[]
  feedback            Feedback[]

  @@map("users")
}

model EmailVerification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verifications")
}

// ============================================================================
// PRODUCT CATALOG
// ============================================================================

model Category {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  parentId    String?   @map("parent_id")
  imageUrl    String?   @map("image_url")
  sortOrder   Int       @default(0) @map("sort_order")
  isActive    Boolean   @default(true) @map("is_active")
  metadata    Json?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@index([parentId])
  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

model Product {
  id                String   @id @default(uuid())
  name              String
  slug              String   @unique
  sku               String   @unique
  description       String?
  price             Decimal  @db.Decimal(10, 2)
  compareAtPrice    Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  costPerItem       Decimal? @map("cost_per_item") @db.Decimal(10, 2)
  categoryId        String?  @map("category_id")
  images            String[] @default([])
  featuredImage     String?  @map("featured_image")
  inventoryCount    Int      @default(0) @map("inventory_count")
  trackInventory    Boolean  @default(true) @map("track_inventory")
  lowStockThreshold Int      @default(5) @map("low_stock_threshold")
  tags              String[] @default([])
  weight            Decimal? @db.Decimal(10, 2)
  vendor            String?
  isActive          Boolean  @default(true) @map("is_active")
  isFeatured        Boolean  @default(false) @map("is_featured")
  seoTitle          String?  @map("seo_title")
  seoDescription    String?  @map("seo_description")
  publishedAt       DateTime? @map("published_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  category         Category?          @relation(fields: [categoryId], references: [id])
  variants         ProductVariant[]
  orderItems       OrderItem[]
  cartItems        CartItem[]
  wishlists        Wishlist[]
  reviews          Review[]
  inventoryLogs    InventoryLog[]
  purchaseOrderItems PurchaseOrderItem[]
  investorAllocations InvestorProductAllocation[]

  @@index([categoryId])
  @@index([sku])
  @@index([slug])
  @@index([isActive])
  @@index([isFeatured])
  @@map("products")
}

model ProductVariant {
  id             String   @id @default(uuid())
  productId      String   @map("product_id")
  name           String
  sku            String   @unique
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  inventoryCount Int      @default(0) @map("inventory_count")
  imageUrl       String?  @map("image_url")
  options        Json?
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]
  cartItems     CartItem[]
  inventoryLogs InventoryLog[]
  investorAllocations InvestorProductAllocation[]

  @@index([productId])
  @@index([sku])
  @@index([isActive])
  @@map("product_variants")
}

// ============================================================================
// ORDER MANAGEMENT
// ============================================================================

enum OrderStatus {
  pending
  paid
  processing
  shipped
  out_for_delivery
  delivered
  cancelled
  refunded
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

enum PaymentMethod {
  card
  cash
  mobile_payment
}

enum ShippingMethod {
  standard
  express
  overnight
  in_store
}

model Order {
  id                   String         @id @default(uuid())
  orderNumber          String         @unique @map("order_number")
  userId               String?        @map("user_id")
  guestEmail           String?        @map("guest_email")
  orderStatus          OrderStatus    @default(pending) @map("order_status")
  paymentStatus        PaymentStatus  @default(pending) @map("payment_status")
  paymentMethod        PaymentMethod  @default(card) @map("payment_method")
  shippingMethod       ShippingMethod @default(standard) @map("shipping_method")
  subtotal             Decimal        @db.Decimal(10, 2)
  shippingCost         Decimal        @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  taxAmount            Decimal        @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount       Decimal        @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount          Decimal        @map("total_amount") @db.Decimal(10, 2)
  shippingAddress      Json?          @map("shipping_address")
  billingAddress       Json?          @map("billing_address")
  stripePaymentIntentId String?       @map("stripe_payment_intent_id")
  stripeChargeId       String?        @map("stripe_charge_id")
  trackingNumber       String?        @map("tracking_number")
  carrier              String?
  estimatedDeliveryDate DateTime?     @map("estimated_delivery_date")
  customerNotes        String?        @map("customer_notes")
  adminNotes           String?        @map("admin_notes")
  couponCode           String?        @map("coupon_code")

  // POS specific fields
  isPosOrder           Boolean        @default(false) @map("is_pos_order")
  cashierId            String?        @map("cashier_id")
  posSessionId         String?        @map("pos_session_id")
  customerName         String?        @map("customer_name")
  customerPhone        String?        @map("customer_phone")
  amountTendered       Decimal?       @map("amount_tendered") @db.Decimal(10, 2)
  changeGiven          Decimal?       @map("change_given") @db.Decimal(10, 2)

  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")
  paidAt               DateTime?      @map("paid_at")
  shippedAt            DateTime?      @map("shipped_at")
  deliveredAt          DateTime?      @map("delivered_at")
  cancelledAt          DateTime?      @map("cancelled_at")

  // Relations
  user            User?             @relation(fields: [userId], references: [id])
  cashier         Cashier?          @relation(fields: [cashierId], references: [id])
  posSession      POSSession?       @relation(fields: [posSessionId], references: [id])
  orderItems      OrderItem[]
  reviews         Review[]
  shippingTracking ShippingTracking?
  inventoryLogs   InventoryLog[]
  serviceBooking  ServiceBooking?
  orderItemServices OrderItemService[]
  equipmentJobUsages EquipmentJobUsage[]

  @@index([userId])
  @@index([guestEmail])
  @@index([orderNumber])
  @@index([orderStatus])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([stripePaymentIntentId])
  @@index([cashierId])
  @@index([posSessionId])
  @@index([isPosOrder])
  @@map("orders")
}

model OrderItem {
  id             String  @id @default(uuid())
  orderId        String  @map("order_id")
  productId      String  @map("product_id")
  variantId      String? @map("variant_id")
  productName    String  @map("product_name")
  productSku     String  @map("product_sku")
  productImage   String? @map("product_image")
  variantOptions Json?   @map("variant_options")
  quantity       Int
  price          Decimal @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ============================================================================
// SHOPPING FEATURES
// ============================================================================

model CartItem {
  id        String          @id @default(uuid())
  userId    String          @map("user_id")
  productId String          @map("product_id")
  variantId String?         @map("variant_id")
  quantity  Int
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  // Relations
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([userId, productId, variantId])
  @@index([userId])
  @@index([productId])
  @@map("cart_items")
}

model Wishlist {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  productId String   @map("product_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("wishlists")
}

model Review {
  id                String    @id @default(uuid())
  productId         String    @map("product_id")
  userId            String    @map("user_id")
  orderId           String?   @map("order_id")
  rating            Int
  title             String?
  content           String?
  images            String[]  @default([])
  verifiedPurchase  Boolean   @default(false) @map("verified_purchase")
  isApproved        Boolean   @default(false) @map("is_approved")
  helpfulCount      Int       @default(0) @map("helpful_count")
  adminResponse     String?   @map("admin_response")
  adminRespondedAt  DateTime? @map("admin_responded_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  order   Order?  @relation(fields: [orderId], references: [id])

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@index([isApproved])
  @@index([createdAt])
  @@map("reviews")
}

// ============================================================================
// PROMOTIONS
// ============================================================================

enum CouponType {
  percentage
  fixed
}

model Coupon {
  id              String      @id @default(uuid())
  code            String      @unique
  type            CouponType
  value           Decimal     @db.Decimal(10, 2)
  minimumPurchase Decimal?    @map("minimum_purchase") @db.Decimal(10, 2)
  maximumDiscount Decimal?    @map("maximum_discount") @db.Decimal(10, 2)
  usageLimit      Int?        @map("usage_limit")
  usageCount      Int         @default(0) @map("usage_count")
  perUserLimit    Int?        @map("per_user_limit")
  isActive        Boolean     @default(true) @map("is_active")
  startsAt        DateTime?   @map("starts_at")
  expiresAt       DateTime?   @map("expires_at")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

// ============================================================================
// CUSTOMER ADDRESS MANAGEMENT
// ============================================================================

model Address {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  fullName     String   @map("full_name")
  phone        String
  addressLine1 String   @map("address_line1")
  addressLine2 String?  @map("address_line2")
  city         String
  state        String
  postalCode   String   @map("postal_code")
  country      String
  isDefault    Boolean  @default(false) @map("is_default")
  label        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

// ============================================================================
// DELIVERY & TRACKING
// ============================================================================

model Driver {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  fullName         String   @map("full_name")
  phone            String
  email            String
  photoUrl         String?  @map("photo_url")
  vehicleType      String   @map("vehicle_type")
  vehicleNumber    String   @map("vehicle_number")
  licenseNumber    String   @map("license_number")
  isActive         Boolean  @default(true) @map("is_active")
  isAvailable      Boolean  @default(true) @map("is_available")
  rating           Decimal? @db.Decimal(3, 2)
  totalDeliveries  Int      @default(0) @map("total_deliveries")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingTracking ShippingTracking[]

  @@index([userId])
  @@index([isActive])
  @@index([isAvailable])
  @@map("drivers")
}

model Cashier {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  fullName         String   @map("full_name")
  phone            String
  email            String
  photoUrl         String?  @map("photo_url")
  employeeId       String?  @unique @map("employee_id")
  isActive         Boolean  @default(true) @map("is_active")
  totalSales       Decimal  @default(0) @map("total_sales") @db.Decimal(10, 2)
  totalOrders      Int      @default(0) @map("total_orders")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders      Order[]
  posSessions POSSession[]

  @@index([userId])
  @@index([isActive])
  @@index([employeeId])
  @@map("cashiers")
}

model Tailor {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  fullName         String   @map("full_name")
  phone            String
  email            String
  photoUrl         String?  @map("photo_url")
  employeeId       String?  @unique @map("employee_id")
  specialties      String[] @default([]) // e.g., ["dresses", "suits", "alterations"]
  isActive         Boolean  @default(true) @map("is_active")
  totalOrders      Int      @default(0) @map("total_orders")
  averageRating    Decimal? @map("average_rating") @db.Decimal(3, 2)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  measurements        Measurement[]
  fittingAppointments FittingAppointment[]

  @@index([userId])
  @@index([isActive])
  @@index([employeeId])
  @@map("tailors")
}

enum POSSessionStatus {
  open
  closed
  suspended
}

model POSSession {
  id               String           @id @default(uuid())
  sessionNumber    String           @unique @map("session_number")
  cashierId        String           @map("cashier_id")
  status           POSSessionStatus @default(open)
  openingBalance   Decimal          @default(0) @map("opening_balance") @db.Decimal(10, 2)
  closingBalance   Decimal?         @map("closing_balance") @db.Decimal(10, 2)
  expectedCash     Decimal          @default(0) @map("expected_cash") @db.Decimal(10, 2)
  actualCash       Decimal?         @map("actual_cash") @db.Decimal(10, 2)
  cashDifference   Decimal?         @map("cash_difference") @db.Decimal(10, 2)
  totalSales       Decimal          @default(0) @map("total_sales") @db.Decimal(10, 2)
  totalOrders      Int              @default(0) @map("total_orders")
  totalCash        Decimal          @default(0) @map("total_cash") @db.Decimal(10, 2)
  totalCard        Decimal          @default(0) @map("total_card") @db.Decimal(10, 2)
  totalMobile      Decimal          @default(0) @map("total_mobile") @db.Decimal(10, 2)
  notes            String?
  openedAt         DateTime         @default(now()) @map("opened_at")
  closedAt         DateTime?        @map("closed_at")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  cashier Cashier @relation(fields: [cashierId], references: [id])
  orders  Order[]

  @@index([cashierId])
  @@index([status])
  @@index([openedAt])
  @@map("pos_sessions")
}

enum TrackingStatus {
  assigned
  picked_up
  in_transit
  out_for_delivery
  delivered
  failed
}

model ShippingTracking {
  id                    String         @id @default(uuid())
  orderId               String         @unique @map("order_id")
  driverId              String?        @map("driver_id")
  status                TrackingStatus @default(assigned)
  currentLocation       String?        @map("current_location")
  pickupLocation        String?        @map("pickup_location")
  deliveryLocation      String?        @map("delivery_location")
  estimatedDeliveryTime DateTime?      @map("estimated_delivery_time")
  actualDeliveryTime    DateTime?      @map("actual_delivery_time")
  notes                 String?
  signatureUrl          String?        @map("signature_url")
  photoUrl              String?        @map("photo_url")
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")

  // Relations
  order           Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  driver          Driver?           @relation(fields: [driverId], references: [id])
  trackingHistory TrackingHistory[]

  @@index([orderId])
  @@index([driverId])
  @@index([status])
  @@map("shipping_tracking")
}

model TrackingHistory {
  id         String   @id @default(uuid())
  trackingId String   @map("tracking_id")
  location   String?
  recordedAt DateTime @default(now()) @map("recorded_at")

  // Relations
  tracking ShippingTracking @relation(fields: [trackingId], references: [id], onDelete: Cascade)

  @@index([trackingId])
  @@index([recordedAt])
  @@map("tracking_history")
}

// ============================================================================
// INVENTORY MANAGEMENT
// ============================================================================

enum InventoryAction {
  received
  sold
  returned
  damaged
  adjustment
}

model InventoryLog {
  id             String          @id @default(uuid())
  productId      String          @map("product_id")
  variantId      String?         @map("variant_id")
  action         InventoryAction
  quantityChange Int             @map("quantity_change")
  quantityAfter  Int             @map("quantity_after")
  orderId        String?         @map("order_id")
  userId         String?         @map("user_id")
  notes          String?
  createdAt      DateTime        @default(now()) @map("created_at")

  // Relations
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id])
  order   Order?          @relation(fields: [orderId], references: [id])
  user    User?           @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([variantId])
  @@index([action])
  @@index([createdAt])
  @@map("inventory_logs")
}

// ============================================================================
// SUPPLIER & PROCUREMENT MANAGEMENT
// ============================================================================

model Supplier {
  id              String   @id @default(uuid())
  name            String
  contactPerson   String?  @map("contact_person")
  email           String   @unique
  phone           String?
  address         Json     // {street, city, state, postal_code, country}
  paymentTerms    String   @default("net_30") @map("payment_terms") // net_30, net_60, cod, etc.
  taxId           String?  @map("tax_id")
  bankDetails     Json?    @map("bank_details") // {bank_name, account_number, routing_number}
  rating          Decimal  @default(0) @db.Decimal(3, 2)
  notes           String?
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  purchaseOrders  PurchaseOrder[]

  @@index([email])
  @@index([isActive])
  @@map("suppliers")
}

enum PurchaseOrderStatus {
  draft
  sent
  confirmed
  shipped
  partial_received
  received
  completed
  cancelled
}

model PurchaseOrder {
  id                  String              @id @default(uuid())
  poNumber            String              @unique @map("po_number")
  supplierId          String              @map("supplier_id")
  orderDate           DateTime            @default(now()) @map("order_date")
  expectedDeliveryDate DateTime?          @map("expected_delivery_date")
  status              PurchaseOrderStatus @default(draft)
  subtotal            Decimal             @db.Decimal(10, 2)
  taxAmount           Decimal             @default(0) @map("tax_amount") @db.Decimal(10, 2)
  shippingCost        Decimal             @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  totalAmount         Decimal             @map("total_amount") @db.Decimal(10, 2)
  paymentTerms        String              @map("payment_terms")
  paymentStatus       PaymentStatus       @default(pending) @map("payment_status")
  paymentDate         DateTime?           @map("payment_date")
  notes               String?
  createdById         String              @map("created_by_id")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // Relations
  supplier      Supplier            @relation(fields: [supplierId], references: [id])
  createdBy     User                @relation(fields: [createdById], references: [id])
  items         PurchaseOrderItem[]
  goodsReceipts GoodsReceipt[]
  paymentConfirmations PaymentConfirmation[]

  @@index([supplierId])
  @@index([poNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String        @map("purchase_order_id")
  productId       String        @map("product_id")
  quantity        Int
  quantityReceived Int          @default(0) @map("quantity_received")
  unitPrice       Decimal       @db.Decimal(10, 2) @map("unit_price")
  lineTotal       Decimal       @db.Decimal(10, 2) @map("line_total")
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("purchase_order_items")
}

model GoodsReceipt {
  id              String        @id @default(uuid())
  receiptNumber   String        @unique @map("receipt_number")
  purchaseOrderId String        @map("purchase_order_id")
  receivedDate    DateTime      @default(now()) @map("received_date")
  receivedById    String        @map("received_by_id")
  items           Json          // [{productId, quantityReceived, condition, notes}]
  discrepancyNotes String?      @map("discrepancy_notes")
  photos          Json?         // [image URLs]
  signatureUrl    String?       @map("signature_url")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  receivedBy    User          @relation(fields: [receivedById], references: [id])

  @@index([purchaseOrderId])
  @@index([receiptNumber])
  @@index([receivedDate])
  @@map("goods_receipts")
}

model PaymentConfirmation {
  id              String        @id @default(uuid())
  token           String        @unique
  purchaseOrderId String        @map("purchase_order_id")
  isConfirmed     Boolean       @default(false) @map("is_confirmed")
  confirmedAt     DateTime?     @map("confirmed_at")
  confirmedIp     String?       @map("confirmed_ip")
  expiresAt       DateTime      @map("expires_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([purchaseOrderId])
  @@index([isConfirmed])
  @@map("payment_confirmations")
}

// ============================================================================
// SERVICES & BOOKING SYSTEM
// ============================================================================

enum ServiceDuration {
  half_hour    // 30 minutes
  one_hour     // 1 hour
  two_hours    // 2 hours
  half_day     // 4 hours
  full_day     // 8 hours
  custom       // Custom duration
}

enum ServiceType {
  onsite              // On-site service (installation/repair at customer location)
  custom_production   // Create product from scratch
  collect_repair      // Collect & repair/renew (workshop service)
}

enum CollectionMethod {
  customer_brings     // Customer brings item to shop
  admin_collects      // Admin collects from customer location
}

enum BookingStatus {
  pending           // Initial booking, payment pending
  quote_pending     // Waiting for admin to create quote
  quote_sent        // Quote sent to customer
  quote_approved    // Customer approved quote
  quote_rejected    // Customer rejected quote
  awaiting_payment  // Waiting for down payment
  payment_partial   // Partial payment received
  confirmed         // Payment received, booking confirmed
  in_progress       // Service is being performed
  awaiting_collection // Work complete, awaiting customer collection
  completed         // Service completed
  cancelled         // Cancelled by customer or admin
  no_show           // Customer didn't show up
  rescheduled       // Booking was rescheduled
}

enum QuoteStatus {
  draft      // Quote being created
  sent       // Quote sent to customer
  approved   // Customer approved
  rejected   // Customer rejected
  expired    // Quote expired
}

enum MaterialRequestStatus {
  pending    // Request pending admin review
  approved   // Admin approved request
  acquired   // Material acquired
  cancelled  // Request cancelled
}

enum PaymentType {
  down_payment     // Down payment (deposit)
  partial_payment  // Partial payment
  final_payment    // Final payment
  refund           // Refund
}

enum ProgressStatus {
  pending             // Work not started
  material_ordered    // Materials ordered
  material_received   // Materials received
  in_production       // Work in progress
  quality_check       // Quality check in progress
  ready_for_collection // Ready for customer collection
  completed           // Work completed
}

model ServiceCategory {
  id          String    @id @default(uuid())
  name        String    @unique
  slug        String    @unique
  description String?
  imageUrl    String?   @map("image_url")
  icon        String?   // Icon name for UI
  sortOrder   Int       @default(0) @map("sort_order")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  services  Service[]
  materials Material[]

  @@index([slug])
  @@index([isActive])
  @@map("service_categories")
}

model Service {
  id                       String           @id @default(uuid())
  name                     String
  slug                     String           @unique
  sku                      String           @unique
  description              String?
  shortDescription         String?          @map("short_description")
  price                    Decimal          @db.Decimal(10, 2)
  compareAtPrice           Decimal?         @map("compare_at_price") @db.Decimal(10, 2)
  categoryId               String           @map("category_id")
  images                   String[]         @default([])
  featuredImage            String?          @map("featured_image")
  duration                 ServiceDuration  @default(one_hour)
  customDuration           Int?             @map("custom_duration") // in minutes if custom
  bufferTime               Int              @default(0) @map("buffer_time") // Minutes between bookings
  maxBookingsPerDay        Int?             @map("max_bookings_per_day")

  // Service Type Flags (NEW)
  supportsOnsite           Boolean          @default(true) @map("supports_onsite")
  supportsCustomProduction Boolean          @default(false) @map("supports_custom_production")
  supportsCollectRepair    Boolean          @default(false) @map("supports_collect_repair")

  isActive                 Boolean          @default(true) @map("is_active")
  isFeatured               Boolean          @default(false) @map("is_featured")
  tags                     String[]         @default([])
  seoTitle                 String?          @map("seo_title")
  seoDescription           String?          @map("seo_description")
  metadata                 Json?            // Custom fields, requirements, etc.
  createdAt                DateTime         @default(now()) @map("created_at")
  updatedAt                DateTime         @updatedAt @map("updated_at")

  // Relations
  category          ServiceCategory     @relation(fields: [categoryId], references: [id])
  bookings          ServiceBooking[]
  availability      ServiceAvailability[]
  blockouts         ServiceBlockout[]
  cartItems         CartItemService[]
  orderItems        OrderItemService[]
  materials         ServiceMaterial[]    // Link to materials
  upcomingServices  UpcomingService[]    // Link to upcoming services
  bookingReviews    BookingReview[]      // Reviews from completed bookings

  @@index([categoryId])
  @@index([slug])
  @@index([sku])
  @@index([isActive])
  @@index([isFeatured])
  @@map("services")
}

// Weekly availability schedule
model ServiceAvailability {
  id          String   @id @default(uuid())
  serviceId   String   @map("service_id")
  dayOfWeek   Int      @map("day_of_week") // 0 = Sunday, 1 = Monday, etc.
  startTime   String   @map("start_time")   // "09:00"
  endTime     String   @map("end_time")     // "17:00"
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([dayOfWeek])
  @@map("service_availability")
}

// Specific date/time blockouts (holidays, maintenance, etc.)
model ServiceBlockout {
  id          String    @id @default(uuid())
  serviceId   String?   @map("service_id") // null = applies to all services
  startDate   DateTime  @map("start_date")
  endDate     DateTime  @map("end_date")
  reason      String?
  isRecurring Boolean   @default(false) @map("is_recurring")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  service Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([startDate, endDate])
  @@map("service_blockouts")
}

model ServiceBooking {
  id                 String            @id @default(uuid())
  bookingNumber      String            @unique @map("booking_number")
  serviceId          String            @map("service_id")
  userId             String?           @map("user_id")
  orderId            String?           @unique @map("order_id") // Links to Order after payment
  status             BookingStatus     @default(pending)

  // Service Type & Collection (NEW)
  serviceType        ServiceType       @map("service_type")
  collectionMethod   CollectionMethod? @map("collection_method")

  // Scheduling (optional for custom production and collect/repair)
  scheduledDate      DateTime?         @map("scheduled_date")
  scheduledTime      String?           @map("scheduled_time") // "14:00"
  endTime            String?           @map("end_time")       // "16:00"
  duration           Int               // Duration in minutes

  // Customer Information
  customerName       String            @map("customer_name")
  customerEmail      String            @map("customer_email")
  customerPhone      String?           @map("customer_phone")
  customerNotes      String?           @map("customer_notes")

  // Enhanced Requirements (NEW)
  requirementPhotos        String[]  @default([]) @map("requirement_photos")
  desiredOutcome           String?   @map("desired_outcome")
  customerProvidedMaterials Boolean  @default(false) @map("customer_provided_materials")

  // Pricing
  price              Decimal           @db.Decimal(10, 2)
  finalPrice         Decimal?          @map("final_price") @db.Decimal(10, 2) // Locked price after quote approval

  // Admin
  adminNotes         String?           @map("admin_notes")
  cancellationReason String?           @map("cancellation_reason")
  rescheduledFrom    String?           @map("rescheduled_from") // Previous booking ID

  // Timestamps
  completedAt        DateTime?         @map("completed_at")
  cancelledAt        DateTime?         @map("cancelled_at")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  // Relations
  service          Service              @relation(fields: [serviceId], references: [id])
  user             User?                @relation(fields: [userId], references: [id])
  order            Order?               @relation(fields: [orderId], references: [id])

  // NEW Relations
  quote            Quote?
  materials        BookingMaterial[]
  materialRequests MaterialRequest[]
  progressUpdates  BookingProgress[]
  timeline         BookingTimeline[]
  payments         BookingPayment[]
  measurement      Measurement?
  fittingAppointments FittingAppointment[]
  equipmentJobUsages EquipmentJobUsage[]
  review             BookingReview?

  @@index([serviceId])
  @@index([userId])
  @@index([orderId])
  @@index([status])
  @@index([serviceType])
  @@index([scheduledDate])
  @@index([bookingNumber])
  @@map("service_bookings")
}

// ============================================================================
// BOOKING REVIEWS
// ============================================================================

model BookingReview {
  id        String   @id @default(uuid())
  bookingId String   @unique @map("booking_id")
  userId    String   @map("user_id")
  serviceId String   @map("service_id")
  rating    Int      // 1-5
  title     String?
  content   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  booking ServiceBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id])
  service Service        @relation(fields: [serviceId], references: [id])

  @@index([userId])
  @@index([serviceId])
  @@index([rating])
  @@map("booking_reviews")
}

// ============================================================================
// MATERIAL MANAGEMENT
// ============================================================================

model Material {
  id                 String            @id @default(uuid())
  sku                String            @unique
  name               String
  description        String?
  price              Decimal           @db.Decimal(10, 2)
  stockQuantity      Int               @default(0) @map("stock_quantity")
  unit               String            @default("piece") // piece, meter, kg, liter, etc.
  imageUrl           String?           @map("image_url")
  specifications     Json?             // Material specifications (color, dimensions, etc.)
  notes              String?           // Additional notes about the material
  serviceCategoryId  String?           @map("service_category_id")
  isActive           Boolean           @default(true) @map("is_active")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  // Relations
  category    ServiceCategory?  @relation(fields: [serviceCategoryId], references: [id])
  services    ServiceMaterial[]
  bookings    BookingMaterial[]

  @@index([serviceCategoryId])
  @@index([sku])
  @@index([isActive])
  @@map("materials")
}

// Join table: Service <-> Material (many-to-many)
model ServiceMaterial {
  id              String   @id @default(uuid())
  serviceId       String   @map("service_id")
  materialId      String   @map("material_id")
  isRequired      Boolean  @default(false) @map("is_required")
  defaultQuantity Int      @default(1) @map("default_quantity")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  service  Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([serviceId, materialId])
  @@index([serviceId])
  @@index([materialId])
  @@map("service_materials")
}

// Materials selected for a booking
model BookingMaterial {
  id              String   @id @default(uuid())
  bookingId       String   @map("booking_id")
  materialId      String   @map("material_id")
  quantity        Int
  priceAtBooking  Decimal  @map("price_at_booking") @db.Decimal(10, 2) // Lock price
  isAcquired      Boolean  @default(false) @map("is_acquired")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  booking  ServiceBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  material Material       @relation(fields: [materialId], references: [id])

  @@index([bookingId])
  @@index([materialId])
  @@map("booking_materials")
}

// Customer requests for unavailable materials
model MaterialRequest {
  id              String                 @id @default(uuid())
  bookingId       String                 @map("booking_id")
  description     String
  referenceUrl    String?                @map("reference_url")
  referencePhotos String[]               @default([]) @map("reference_photos")
  status          MaterialRequestStatus  @default(pending)
  adminNotes      String?                @map("admin_notes")
  createdAt       DateTime               @default(now()) @map("created_at")
  updatedAt       DateTime               @updatedAt @map("updated_at")

  // Relations
  booking ServiceBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([status])
  @@map("material_requests")
}

// ============================================================================
// QUOTE SYSTEM
// ============================================================================

model Quote {
  id                 String       @id @default(uuid())
  bookingId          String       @unique @map("booking_id")
  materialCost       Decimal      @db.Decimal(10, 2) @map("material_cost")
  laborCost          Decimal      @db.Decimal(10, 2) @map("labor_cost")
  laborHours         Decimal      @db.Decimal(5, 2) @map("labor_hours")
  totalCost          Decimal      @db.Decimal(10, 2) @map("total_cost")
  downPaymentAmount  Decimal      @db.Decimal(10, 2) @map("down_payment_amount")
  notes              String?
  status             QuoteStatus  @default(draft)
  validUntil         DateTime?    @map("valid_until")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  // Relations
  booking ServiceBooking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  history QuoteHistory[]

  @@index([bookingId])
  @@index([status])
  @@map("quotes")
}

model QuoteHistory {
  id         String   @id @default(uuid())
  quoteId    String   @map("quote_id")
  action     String   // e.g., "created", "sent", "approved", "rejected"
  notes      String?
  createdBy  String   @map("created_by") // User ID or "customer"
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([createdAt])
  @@map("quote_history")
}

// ============================================================================
// PROGRESS TRACKING
// ============================================================================

model BookingProgress {
  id          String         @id @default(uuid())
  bookingId   String         @map("booking_id")
  status      ProgressStatus
  description String
  photos      String[]       @default([])
  createdBy   String         @map("created_by") // Admin user ID
  createdAt   DateTime       @default(now()) @map("created_at")

  // Relations
  booking ServiceBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([createdAt])
  @@map("booking_progress")
}

model BookingTimeline {
  id           String    @id @default(uuid())
  bookingId    String    @map("booking_id")
  milestone    String
  expectedDate DateTime? @map("expected_date")
  actualDate   DateTime? @map("actual_date")
  notes        String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  booking ServiceBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@map("booking_timeline")
}

// ============================================================================
// PAYMENT TRACKING
// ============================================================================

model BookingPayment {
  id               String      @id @default(uuid())
  bookingId        String      @map("booking_id")
  amount           Decimal     @db.Decimal(10, 2)
  paymentType      PaymentType @map("payment_type")
  paymentMethod    String      // stripe, cash, bank_transfer
  status           String      @default("pending") // pending, completed, failed, refunded
  stripePaymentId  String?     @map("stripe_payment_id")
  notes            String?
  createdAt        DateTime    @default(now()) @map("created_at")

  // Relations
  booking ServiceBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([paymentType])
  @@index([status])
  @@map("booking_payments")
}

// ============================================================================
// TAILOR SYSTEM - MEASUREMENTS & FITTINGS
// ============================================================================

model Measurement {
  id                    String         @id @default(uuid())
  bookingId             String         @unique @map("booking_id")
  tailorId              String         @map("tailor_id")
  measurements          Json           // Flexible structure for different garment types
  notes                 String?
  customerSignatureUrl  String?        @map("customer_signature_url")
  takenAt               DateTime       @default(now()) @map("taken_at")
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")

  // Relations
  booking ServiceBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  tailor  Tailor         @relation(fields: [tailorId], references: [id], onDelete: Restrict)

  @@index([bookingId])
  @@index([tailorId])
  @@index([takenAt])
  @@map("measurements")
}

enum FittingStatus {
  scheduled
  customer_called
  completed
  no_show
  rescheduled
  cancelled
}

model FittingAppointment {
  id              String        @id @default(uuid())
  bookingId       String        @map("booking_id")
  tailorId        String        @map("tailor_id")
  scheduledDate   DateTime      @map("scheduled_date")
  scheduledTime   String        @map("scheduled_time")
  durationMinutes Int           @default(30) @map("duration_minutes")
  customerCalled  Boolean       @default(false) @map("customer_called")
  calledAt        DateTime?     @map("called_at")
  calledBy        String?       @map("called_by") // User ID who made the call
  attended        Boolean?
  attendedAt      DateTime?     @map("attended_at")
  notes           String?
  fittingNumber   Int           @default(1) @map("fitting_number") // 1st fitting, 2nd fitting, etc.
  status          FittingStatus @default(scheduled)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  booking ServiceBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  tailor  Tailor         @relation(fields: [tailorId], references: [id], onDelete: Restrict)

  @@index([bookingId])
  @@index([tailorId])
  @@index([scheduledDate])
  @@index([status])
  @@map("fitting_appointments")
}

// ============================================================================
// CART & ORDER ITEMS FOR SERVICES
// ============================================================================

// Extend CartItem for services (separate table to maintain type safety)
model CartItemService {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  serviceId      String   @map("service_id")
  scheduledDate  DateTime @map("scheduled_date")
  scheduledTime  String   @map("scheduled_time")
  customerNotes  String?  @map("customer_notes")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([userId, serviceId, scheduledDate, scheduledTime])
  @@index([userId])
  @@index([serviceId])
  @@map("cart_item_services")
}

// Extend OrderItem for services
model OrderItemService {
  id             String   @id @default(uuid())
  orderId        String   @map("order_id")
  serviceId      String   @map("service_id")
  bookingId      String?  @map("booking_id") // Links to ServiceBooking
  serviceName    String   @map("service_name")
  serviceSku     String   @map("service_sku")
  serviceImage   String?  @map("service_image")
  scheduledDate  DateTime @map("scheduled_date")
  scheduledTime  String   @map("scheduled_time")
  duration       Int      // Duration in minutes
  price          Decimal  @db.Decimal(10, 2)
  customerNotes  String?  @map("customer_notes")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id])

  @@index([orderId])
  @@index([serviceId])
  @@index([bookingId])
  @@map("order_item_services")
}

// ============================================================================
// HERO BANNER MANAGEMENT
// ============================================================================

enum BannerType {
  advertisement
  new_product
  new_service
  promotion
  announcement
  upcoming
}

model HeroBanner {
  id              String      @id @default(uuid())
  title           String
  subtitle        String?
  description     String?
  type            BannerType  @default(announcement)
  imageUrl        String      @map("image_url")
  mobileImageUrl  String?     @map("mobile_image_url") // Optional mobile-specific image
  ctaText         String?     @map("cta_text") // Call-to-action button text
  ctaLink         String?     @map("cta_link") // Call-to-action link
  ctaStyle        String?     @default("primary") @map("cta_style") // Button style: primary, secondary, outline
  backgroundColor String?     @default("#000000") @map("background_color")
  textColor       String?     @default("#ffffff") @map("text_color")
  order           Int         @default(0) // Display order (lower = first)
  isActive        Boolean     @default(true) @map("is_active")
  startDate       DateTime?   @map("start_date") // Optional scheduled start
  endDate         DateTime?   @map("end_date") // Optional scheduled end
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([order])
  @@index([type])
  @@index([startDate])
  @@index([endDate])
  @@map("hero_banners")
}

// ============================================================================
// UPCOMING SERVICES
// ============================================================================

model UpcomingService {
  id               String    @id @default(uuid())
  title            String
  description      String?
  shortDescription String?   @map("short_description")
  imageUrl         String    @map("image_url")
  serviceDate      DateTime  @map("service_date")    // Date when service launches
  serviceId        String?   @map("service_id")      // Optional link to existing Service
  ctaText          String?   @default("Learn More") @map("cta_text")
  location         String?                           // Where service will be offered
  price            Decimal?  @db.Decimal(10, 2)      // Expected price (optional)
  order            Int       @default(0)
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  service          Service?  @relation(fields: [serviceId], references: [id])

  @@index([isActive])
  @@index([order])
  @@index([serviceDate])
  @@index([serviceId])
  @@map("upcoming_services")
}

// ============================================================================
// INVESTOR MANAGEMENT SYSTEM
// ============================================================================

enum InvestorStatus {
  pending_verification  // Awaiting ID verification
  active                // Verified and active
  suspended             // Temporarily suspended
  exited                // Exited from investment
}

enum KycStatus {
  not_started           // User hasn't started KYC
  pending               // Documents submitted, awaiting review
  approved              // KYC approved
  rejected              // KYC rejected, user can resubmit
}

enum TransactionType {
  deposit               // Cash deposit by investor
  withdrawal_cash       // Cash withdrawal
  withdrawal_profit     // Profit withdrawal
  withdrawal_product    // Product claimed back
  withdrawal_equipment  // Equipment share withdrawal
  allocation_product    // Cash allocated to product purchase
  allocation_equipment  // Cash allocated to equipment purchase
  profit_credit         // Profit credited from sale
  refund                // Refund to investor
}

enum WithdrawalType {
  cash                  // Withdraw available cash
  profit                // Withdraw profit
  product               // Claim back invested product
  equipment_share       // Exit from equipment investment
}

enum WithdrawalStatus {
  pending               // Awaiting admin approval
  approved              // Approved by admin
  processing            // Being processed
  completed             // Completed
  rejected              // Rejected
  cancelled             // Cancelled by investor
}

enum EquipmentStatus {
  active                // In use
  maintenance           // Under maintenance
  retired               // Retired/sold
}

// Main Investor Profile
model Investor {
  id                String          @id @default(uuid())
  userId            String          @unique @map("user_id")
  investorNumber    String          @unique @map("investor_number") // e.g., INV-2024-001
  fullName          String          @map("full_name")
  email             String          @unique
  phone             String

  // Identification & Verification
  idType            String?         @map("id_type") // passport, national_id, driver_license
  idNumber          String?         @map("id_number")
  idDocumentUrl     String?         @map("id_document_url") // Uploaded ID document (front)
  idDocumentBackUrl String?         @map("id_document_back_url") // Uploaded ID document (back, optional)
  selfieUrl         String?         @map("selfie_url") // Selfie holding ID or just face

  // KYC Verification Status
  kycStatus         KycStatus       @default(not_started) @map("kyc_status")
  kycSubmittedAt    DateTime?       @map("kyc_submitted_at")
  kycRejectionReason String?        @map("kyc_rejection_reason")

  isVerified        Boolean         @default(false) @map("is_verified")
  verifiedAt        DateTime?       @map("verified_at")
  verifiedBy        String?         @map("verified_by") // Admin user ID

  // Wallet Balances
  cashBalance       Decimal         @default(0) @map("cash_balance") @db.Decimal(12, 2)
  profitBalance     Decimal         @default(0) @map("profit_balance") @db.Decimal(12, 2)
  totalInvested     Decimal         @default(0) @map("total_invested") @db.Decimal(12, 2) // Total lifetime deposits
  totalProfit       Decimal         @default(0) @map("total_profit") @db.Decimal(12, 2) // Total lifetime profit
  totalWithdrawn    Decimal         @default(0) @map("total_withdrawn") @db.Decimal(12, 2) // Total withdrawn

  // Agreement
  agreementAccepted Boolean         @default(false) @map("agreement_accepted")
  agreementAcceptedAt DateTime?     @map("agreement_accepted_at")

  // Status
  status            InvestorStatus  @default(pending_verification)
  notes             String?         // Admin notes about investor
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  deposits          InvestorDeposit[]
  transactions      InvestorTransaction[]
  productAllocations InvestorProductAllocation[]
  equipmentAllocations InvestorEquipmentAllocation[]
  profitDistributions ProfitDistribution[]
  withdrawalRequests WithdrawalRequest[]
  feedback          Feedback[]

  @@index([userId])
  @@index([email])
  @@index([investorNumber])
  @@index([status])
  @@index([isVerified])
  @@map("investors")
}

// Track all deposits made by investors
model InvestorDeposit {
  id              String   @id @default(uuid())
  investorId      String   @map("investor_id")

  // Amount fields
  grossAmount     Decimal  @db.Decimal(12, 2) @map("gross_amount") // Total amount sent by investor (e.g., 1010)
  charges         Decimal  @default(0) @db.Decimal(12, 2) // Transaction fees/charges (e.g., 10)
  amount          Decimal  @db.Decimal(12, 2) // Net amount credited to account (e.g., 1000)

  paymentMethod   String   @map("payment_method") // bank_transfer, cash, mobile_money, check
  referenceNumber String?  @map("reference_number") // Bank transfer reference or receipt number

  // Receipt images
  investorReceiptUrl String?  @map("investor_receipt_url") // Receipt uploaded by investor (for mobile money)
  receiptUrl         String?  @map("receipt_url") // Admin receipt/proof image

  notes           String?  // Admin notes

  // Confirmation workflow for mobile money:
  // 1. awaiting_payment - Investor requested, waiting to send money
  // 2. awaiting_admin_confirmation - Investor uploaded receipt, waiting for admin
  // 3. pending_confirmation - Admin confirmed receipt, waiting for investor final confirmation
  // 4. confirmed - Complete
  // 5. disputed - Investor disputed
  confirmationStatus String @default("pending_confirmation") @map("confirmation_status")
  confirmedAt        DateTime? @map("confirmed_at")
  investorNotes      String?   @map("investor_notes") // Notes from investor if they dispute
  adminConfirmedAt   DateTime? @map("admin_confirmed_at") // When admin confirmed receipt

  depositedAt     DateTime @default(now()) @map("deposited_at")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  investor Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)

  @@index([investorId])
  @@index([depositedAt])
  @@index([confirmationStatus])
  @@map("investor_deposits")
}

// Company Equipment/Machinery
model Equipment {
  id                String           @id @default(uuid())
  name              String
  description       String?
  equipmentNumber   String           @unique @map("equipment_number") // e.g., EQP-2024-001
  purchasePrice     Decimal          @db.Decimal(12, 2) @map("purchase_price")
  currentValue      Decimal          @db.Decimal(12, 2) @map("current_value") // Depreciates over time
  purchaseDate      DateTime         @map("purchase_date")
  category          String           // tailoring_machine, printing_press, etc.
  location          String?          // Where equipment is located
  specifications    Json?            // Technical specs
  photos            String[]         @default([])
  status            EquipmentStatus  @default(active)

  // Cost tracking
  maintenanceCost   Decimal          @default(0) @map("maintenance_cost") @db.Decimal(12, 2)
  totalRevenue      Decimal          @default(0) @map("total_revenue") @db.Decimal(12, 2) // Total revenue generated
  totalProfit       Decimal          @default(0) @map("total_profit") @db.Decimal(12, 2) // Total profit distributed

  notes             String?
  retiredAt         DateTime?        @map("retired_at")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  // Relations
  investorAllocations InvestorEquipmentAllocation[]
  jobUsages           EquipmentJobUsage[]

  @@index([equipmentNumber])
  @@index([status])
  @@index([category])
  @@map("equipment")
}

// Links investors to products they funded
model InvestorProductAllocation {
  id                String   @id @default(uuid())
  investorId        String   @map("investor_id")
  productId         String   @map("product_id")
  variantId         String?  @map("variant_id")
  amountAllocated   Decimal  @db.Decimal(12, 2) @map("amount_allocated") // Amount invested
  quantity          Int      // Quantity purchased with this investment
  purchasePrice     Decimal  @db.Decimal(10, 2) @map("purchase_price") // Price per unit
  totalInvestment   Decimal  @db.Decimal(12, 2) @map("total_investment") // amountAllocated

  // Sale tracking
  quantitySold      Int      @default(0) @map("quantity_sold")
  quantityRemaining Int      @map("quantity_remaining")
  profitGenerated   Decimal  @default(0) @map("profit_generated") @db.Decimal(12, 2) // Total profit from sales
  capitalReturned   Decimal  @default(0) @map("capital_returned") @db.Decimal(12, 2) // Capital returned on sales

  notes             String?
  allocatedAt       DateTime @default(now()) @map("allocated_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  investor Investor        @relation(fields: [investorId], references: [id], onDelete: Cascade)
  product  Product         @relation(fields: [productId], references: [id])
  variant  ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([investorId])
  @@index([productId])
  @@index([variantId])
  @@index([allocatedAt])
  @@map("investor_product_allocations")
}

// Links investors to equipment they co-funded
model InvestorEquipmentAllocation {
  id                   String    @id @default(uuid())
  investorId           String    @map("investor_id")
  equipmentId          String    @map("equipment_id")
  amountAllocated      Decimal   @db.Decimal(12, 2) @map("amount_allocated") // Amount invested
  investmentPercentage Decimal   @db.Decimal(5, 2) @map("investment_percentage") // % of equipment value
  profitShare          Decimal   @db.Decimal(5, 2) @map("profit_share") // % of profit from equipment

  // Profit tracking
  totalProfitReceived  Decimal   @default(0) @map("total_profit_received") @db.Decimal(12, 2)

  // Exit tracking
  hasExited            Boolean   @default(false) @map("has_exited")
  exitAmount           Decimal?  @map("exit_amount") @db.Decimal(12, 2) // Amount paid on exit
  exitedAt             DateTime? @map("exited_at")

  notes                String?
  allocatedAt          DateTime  @default(now()) @map("allocated_at")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relations
  investor  Investor  @relation(fields: [investorId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([investorId])
  @@index([equipmentId])
  @@index([hasExited])
  @@map("investor_equipment_allocations")
}

// Track equipment usage for jobs/orders to calculate profit
model EquipmentJobUsage {
  id                 String    @id @default(uuid())
  equipmentId        String    @map("equipment_id")
  orderId            String?   @map("order_id") // For POS/regular orders
  bookingId          String?   @map("booking_id") // For service bookings
  jobDescription     String    @map("job_description")

  // Financial breakdown
  revenue            Decimal   @db.Decimal(12, 2) // Total revenue from job
  materialCost       Decimal   @db.Decimal(12, 2) @map("material_cost")
  laborCost          Decimal   @db.Decimal(12, 2) @map("labor_cost")
  maintenanceCost    Decimal   @default(0) @map("maintenance_cost") @db.Decimal(12, 2)
  taxCost            Decimal   @default(0) @map("tax_cost") @db.Decimal(12, 2)
  otherExpenses      Decimal   @default(0) @map("other_expenses") @db.Decimal(12, 2)
  totalExpenses      Decimal   @db.Decimal(12, 2) @map("total_expenses")
  netProfit          Decimal   @db.Decimal(12, 2) @map("net_profit") // revenue - totalExpenses

  // Profit distribution
  companyProfit      Decimal   @db.Decimal(12, 2) @map("company_profit") // 50% of netProfit
  investorPoolProfit Decimal   @db.Decimal(12, 2) @map("investor_pool_profit") // 50% to be split
  profitDistributed  Boolean   @default(false) @map("profit_distributed")

  notes              String?
  jobDate            DateTime  @default(now()) @map("job_date")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  equipment Equipment       @relation(fields: [equipmentId], references: [id])
  order     Order?          @relation(fields: [orderId], references: [id])
  booking   ServiceBooking? @relation(fields: [bookingId], references: [id])

  @@index([equipmentId])
  @@index([orderId])
  @@index([bookingId])
  @@index([jobDate])
  @@index([profitDistributed])
  @@map("equipment_job_usages")
}

// All financial transactions for investors
model InvestorTransaction {
  id              String          @id @default(uuid())
  investorId      String          @map("investor_id")
  type            TransactionType
  amount          Decimal         @db.Decimal(12, 2)
  balanceAfter    Decimal         @db.Decimal(12, 2) @map("balance_after") // Cash balance after transaction
  profitAfter     Decimal         @db.Decimal(12, 2) @map("profit_after") // Profit balance after transaction

  // References (depending on type)
  productId       String?         @map("product_id")
  equipmentId     String?         @map("equipment_id")
  withdrawalId    String?         @map("withdrawal_id")
  orderId         String?         @map("order_id") // If related to product sale

  description     String
  notes           String?
  createdBy       String?         @map("created_by") // Admin user ID
  createdAt       DateTime        @default(now()) @map("created_at")

  // Relations
  investor Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)

  @@index([investorId])
  @@index([type])
  @@index([createdAt])
  @@map("investor_transactions")
}

// Profit distribution events
model ProfitDistribution {
  id              String   @id @default(uuid())
  investorId      String   @map("investor_id")
  orderId         String?  @map("order_id") // Product sale order
  equipmentId     String?  @map("equipment_id") // Equipment job
  productId       String?  @map("product_id") // Specific product sold

  // Profit calculation
  saleRevenue     Decimal  @db.Decimal(12, 2) @map("sale_revenue")
  saleCost        Decimal  @db.Decimal(12, 2) @map("sale_cost")
  grossProfit     Decimal  @db.Decimal(12, 2) @map("gross_profit") // saleRevenue - saleCost
  companyShare    Decimal  @db.Decimal(12, 2) @map("company_share") // 50%
  investorShare   Decimal  @db.Decimal(12, 2) @map("investor_share") // 50% or proportional
  capitalReturned Decimal  @default(0) @map("capital_returned") @db.Decimal(12, 2) // Original investment

  description     String
  notes           String?
  distributedAt   DateTime @default(now()) @map("distributed_at")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  investor Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)

  @@index([investorId])
  @@index([orderId])
  @@index([equipmentId])
  @@index([productId])
  @@index([distributedAt])
  @@map("profit_distributions")
}

// Investor withdrawal requests
model WithdrawalRequest {
  id                String           @id @default(uuid())
  investorId        String           @map("investor_id")
  requestNumber     String           @unique @map("request_number") // e.g., WDR-2024-001
  type              WithdrawalType
  status            WithdrawalStatus @default(pending)

  // Amount details
  amount            Decimal          @db.Decimal(12, 2) // Requested amount
  approvedAmount    Decimal?         @map("approved_amount") @db.Decimal(12, 2)

  // For product/equipment withdrawal
  productId         String?          @map("product_id")
  variantId         String?          @map("variant_id")
  equipmentId       String?          @map("equipment_id")
  quantity          Int?             // For product withdrawal

  // Processing
  requestReason     String?          @map("request_reason")
  investorNotes     String?          @map("investor_notes")
  adminNotes        String?          @map("admin_notes")
  rejectionReason   String?          @map("rejection_reason")

  // Tracking
  requestedBy       String           @map("requested_by") // Investor user ID
  reviewedBy        String?          @map("reviewed_by") // Admin user ID
  processedBy       String?          @map("processed_by") // Admin user ID

  // Timestamps
  requestedAt       DateTime         @default(now()) @map("requested_at")
  reviewedAt        DateTime?        @map("reviewed_at")
  processedAt       DateTime?        @map("processed_at")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  // Relations
  investor Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)

  @@index([investorId])
  @@index([requestNumber])
  @@index([type])
  @@index([status])
  @@index([requestedAt])
  @@map("withdrawal_requests")
}

// ============================================================================
// ADMIN NOTIFICATIONS
// ============================================================================

enum NotificationType {
  new_order          // New order placed
  order_paid         // Order payment received
  order_cancelled    // Order cancelled
  new_booking        // New service booking
  booking_confirmed  // Booking confirmed
  booking_cancelled  // Booking cancelled
  new_deposit        // Investor deposit
  deposit_confirmed  // Deposit confirmed
  withdrawal_request // Withdrawal request submitted
  new_review         // New product review
  new_feedback       // Investor feedback submitted
  low_stock          // Product low stock alert
  kyc_submitted      // Investor KYC submitted
  quote_approved     // Quote approved by customer
  system             // System notifications
}

enum NotificationPriority {
  low
  normal
  high
  urgent
}

model Notification {
  id          String               @id @default(uuid())
  type        NotificationType
  title       String
  message     String
  priority    NotificationPriority @default(normal)

  // Reference to related entity
  referenceId   String?            @map("reference_id") // ID of order, booking, deposit, etc.
  referenceType String?            @map("reference_type") // "order", "booking", "deposit", etc.
  actionUrl     String?            @map("action_url") // URL to navigate to when clicked

  // Read status
  isRead      Boolean              @default(false) @map("is_read")
  readAt      DateTime?            @map("read_at")

  // Optional: track who read it (for multi-admin setups)
  readBy      String?              @map("read_by")

  // Metadata for additional context
  metadata    Json?

  createdAt   DateTime             @default(now()) @map("created_at")

  @@index([type])
  @@index([isRead])
  @@index([priority])
  @@index([createdAt])
  @@index([referenceType])
  @@map("notifications")
}

// ============================================================================
// APP SETTINGS
// ============================================================================

// Key-value store for app settings
model AppSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   @db.Text
  category  String   @default("general") // general, investor, payment, etc.
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("app_settings")
}

// ============================================================================
// FEEDBACK SYSTEM
// ============================================================================

enum FeedbackType {
  bug_report
  feature_request
  improvement
  general
  complaint
}

enum FeedbackStatus {
  pending           // New feedback, not reviewed
  under_review      // Being reviewed by admin
  in_progress       // Being worked on
  resolved          // Issue resolved or feature implemented
  closed            // Closed without action
}

enum FeedbackPriority {
  low
  medium
  high
  urgent
}

model Feedback {
  id           String           @id @default(uuid())
  investorId   String?          @map("investor_id")
  userId       String?          @map("user_id")
  userEmail    String?          @map("user_email")
  userName     String?          @map("user_name")
  type         FeedbackType     @default(general)
  subject      String
  message      String           @db.Text
  screenshots  String[]         @default([]) // URLs of attached images
  status       FeedbackStatus   @default(pending)
  priority     FeedbackPriority @default(medium)

  // Admin response tracking
  adminResponses FeedbackResponse[]

  // Metadata
  appVersion   String?          @map("app_version")
  deviceInfo   String?          @map("device_info")

  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  resolvedAt   DateTime?        @map("resolved_at")

  // Relations
  investor     Investor?        @relation(fields: [investorId], references: [id], onDelete: Cascade)
  user         User?            @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([investorId])
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([createdAt])
  @@map("feedback")
}

model FeedbackResponse {
  id          String   @id @default(uuid())
  feedbackId  String   @map("feedback_id")
  responderId String   @map("responder_id") // Admin user ID
  message     String   @db.Text
  isInternal  Boolean  @default(false) @map("is_internal") // Internal notes vs visible to investor
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  feedback    Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  @@index([feedbackId])
  @@index([createdAt])
  @@map("feedback_responses")
}
